<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluefy 蓝牙转发器 (No-CORS 版)</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; }
        .card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        button { background: #007AFF; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; width: 100%; }
        button:active { background: #0051a8; }
        #log { background: #f4f4f4; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; border-radius: 4px; }
        .status-dot { inline-block; width: 10px; height: 10px; border-radius: 50%; background: grey; margin-right: 5px; }
        .online { background: #28a745; }
    </style>
</head>
<body>
    <h2>蓝牙数据转发器</h2>
    
    <div class="card">
        <p><span id="dot" class="status-dot"></span> 状态: <span id="statusText">未连接</span></p>
        <button id="connectBtn">连接蓝牙设备 (DSD TECH)</button>
    </div>

    <h4>运行日志:</h4>
    <div id="log"></div>

    <script>
        const WEBHOOK_URL = 'https://webhook.site/c43a2d83-f39f-4122-80e7-3affeb122625';
        const logDiv = document.getElementById('log');
        const statusText = document.getElementById('statusText');
        const dot = document.getElementById('dot');

        function logger(msg) {
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function forwardToWebhook(dataArray) {
            try {
                // 使用 no-cors 模式转发
                await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        raw: Array.from(dataArray),
                        timestamp: Date.now()
                    })
                });
                logger("转发成功 (no-cors)");
            } catch (e) {
                logger("转发失败: " + e.message);
            }
        }

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                logger("正在请求蓝牙权限...");
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb'] // DSD TECH 常用服务ID
                });

                const server = await device.gatt.connect();
                statusText.innerText = "已连接: " + device.name;
                dot.classList.add('online');
                logger("设备已连接");

                const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
                const characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');

                await characteristic.startNotifications();
                logger("通知已开启，监听数据中...");

                let buffer = [];
                let timeout = null;

                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    const value = event.target.value;
                    const uint8Array = new Uint8Array(value.buffer);
                    
                    // 将新数据加入缓存
                    uint8Array.forEach(byte => buffer.push(byte));
                
                    // 清除之前的定时器，如果在 100ms 内又有新数据，就不会发送
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        forwardToWebhook(buffer); // 100ms 内没有新数据了，统一发送
                        buffer = []; // 清空缓存
                    }, 100); 
                });
            } catch (error) {
                logger("错误: " + error);
                console.error(error);
            }
        });
    </script>
</body>
</html>
