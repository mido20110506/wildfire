<!DOCTYPE html>
<html>
<head>
    <title>BLE to Webhook Bridge</title>
</head>
<body>
    <h1>BLE 数据桥接器 (iOS 19)</h1>
    <button onclick="connectBLE()">连接蓝牙设备并开始转发</button>
    <p id="status">状态: 等待连接...</p>
    <div id="data"></div>

    <script>
        const WEBHOOK_URL = 'https://webhook.site/1c092bbd-eb18-4d63-8469-59769226e3c8'; // 替换为你的 Webhook 网址

        async function connectBLE() {
            try {
                // 1. 请求蓝牙设备 (可以根据 UUID 过滤)
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    //optionalServices: ['battery_service'] // 替换为你设备的 Service UUID
                    optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb'] 
                });

                document.getElementById('status').innerText = "状态: 已连接 " + device.name;

                // 2. 连接 GATT 服务器
                const server = await device.gatt.connect();
                
                // 3. 获取服务和特征 (这里以电量服务为例，请替换为你的特征 UUID)
                // 修改 service UUID
                const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');

                // 修改 characteristic UUID
                const characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');

                // 4. 订阅通知
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    const value = event.target.value;
                    // 解析数据 (根据你的协议处理)
                    const uint8Array = new Uint8Array(value.buffer);
                    const rawData = Array.from(uint8Array);
                    
                    console.log('接收到数据:', rawData);
                    document.getElementById('data').innerText = "最新数据: " + JSON.stringify(rawData);

                    // 5. 转发到 Webhook
                    sendToWebhook(rawData, device.name);
                });

            } catch (error) {
                console.log('错误:', error);
                document.getElementById('status').innerText = "错误: " + error;
            }
        }

        function sendToWebhook(data, deviceName) {
            fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    device: deviceName,
                    payload: data,
                    timestamp: new Date().toISOString()
                })
            })
            .then(response => console.log('Webhook 转发成功'))
            .catch(err => console.error('Webhook 转发失败', err));
        }
    </script>
</body>
</html>
